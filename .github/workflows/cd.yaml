name: Continuous Deployment (CD)

on:
  push:
    branches:
      - main # Trigger only on pushes to main

# Environment variables available to all jobs
env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAR_LOCATION: us-central1 # Update if you chose a different region
  IMAGE_NAME: iris-api
  GKE_CLUSTER_NAME: iris-cluster # The name of your GKE cluster
  GKE_ZONE: us-central1-c # Update with your cluster's zone
  MLFLOW_URI_FROM_SECRET: ${{ secrets.MLFLOW_TRACKING_URI }}

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write' # Required for Workload Identity

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud (WIF)
      uses: 'google-github-actions/auth@v2'
      with:
        workload_identity_provider: ${{ secrets.WIF_PROVIDER_ID }}
        service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

    - name: Set up Cloud SDK
      uses: 'google-github-actions/setup-gcloud@v2'

    - name: Authorize Docker push
      run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/iris-api-repo/${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/iris-api-repo/${{ env.IMAGE_NAME }}:latest
        
    - name: Store image URL for deployment
      run: |
        echo "IMAGE_URL=${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/iris-api-repo/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_ENV

  deploy-to-gke:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: build-and-push # Run this job only after build-and-push succeeds
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud (WIF)
      uses: 'google-github-actions/auth@v2'
      with:
        workload_identity_provider: ${{ secrets.WIF_PROVIDER_ID }}
        service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

    - name: Get GKE cluster credentials
      uses: 'google-github-actions/get-gke-credentials@v2'
      with:
        cluster_name: ${{ env.GKE_CLUSTER_NAME }}
        location: ${{ env.GKE_ZONE }}

    - name: Update Kubernetes manifests
      run: |
        sed -i 's|__IMAGE_PLACEHOLDER__|${{ env.IMAGE_URL }}|g' k8s/deployment.yaml
        sed -i 's|__MLFLOW_URI_PLACEHOLDER__|${{ env.MLFLOW_URI_FROM_SECRET }}|g' k8s/deployment.yaml

    - name: Deploy to GKE
      run: |
        kubectl apply -f k8s/
